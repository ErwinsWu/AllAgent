# 飞书AI智能体 1.0 技术路线图

## 项目概述

飞书AI智能体是一个基于大语言模型的智能客服系统，集成飞书平台，为客户提供产品介绍和问答服务。

## 技术架构图

```
┌─────────────────────────────────────────────────────────┐
│                     飞书客户端                            │
└───────────────────┬─────────────────────────────────────┘
                    │ (消息收发)
┌───────────────────▼─────────────────────────────────────┐
│              飞书连接模块 (Feishu Connector)              │
│  - 接收客户消息                                           │
│  - 发送AI回复                                             │
│  - 处理事件回调                                           │
└───────────────────┬─────────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────────┐
│              对话路由器 (Dialog Router)                   │
│  - 意图识别                                               │
│  - 决策查询策略                                           │
└─────┬─────────────────────────────────────┬─────────────┘
      │                                     │
      │ (需要查询文档)                       │ (直接回答)
      │                                     │
┌─────▼──────────────────┐      ┌──────────▼──────────────┐
│  知识库检索模块          │      │    AI对话引擎            │
│  (Knowledge Retriever)  │      │  (AI Dialog Engine)      │
│  - 飞书文档搜索         │      │  - LLM推理              │
│  - 语义检索             │      │  - 上下文管理           │
│  - 内容提取             │      │  - 产品知识注入         │
└─────┬──────────────────┘      └──────────┬──────────────┘
      │                                     │
      └──────────────┬──────────────────────┘
                     │
          ┌──────────▼──────────┐
          │  产品知识管理         │
          │  (Product Knowledge) │
          │  - 产品信息库        │
          │  - FAQ数据           │
          └─────────────────────┘
```

## 技术栈选型

### 后端框架
- **Python 3.10+**: 主要开发语言
- **FastAPI**: Web服务框架，处理webhook
- **uvicorn**: ASGI服务器

### 飞书集成
- **lark-oapi**: 飞书官方Python SDK
- 支持的能力：
  - 消息接收与发送
  - 文档搜索API
  - 知识库API

### AI能力
- **OpenAI API / Claude API**: LLM推理
- **LangChain**: AI应用编排框架
- **tiktoken**: Token计算

### 数据存储
- **SQLite/PostgreSQL**: 对话历史、配置数据
- **Redis** (可选): 会话缓存
- **ChromaDB/FAISS** (可选): 向量检索

## 核心模块功能

### 1. 飞书连接模块 (Feishu Connector)

**职责**: 处理与飞书平台的所有交互

**核心功能**:
- 接收飞书消息事件 (webhook)
- 发送文本/卡片消息
- 处理URL验证
- 消息加解密

**技术实现**:
```python
# 使用lark-oapi SDK
from lark_oapi import Client, Config

# FastAPI接收webhook
@app.post("/webhook/feishu")
async def handle_feishu_event(request: Request):
    # 处理消息事件
    pass
```

### 2. 对话路由器 (Dialog Router)

**职责**: 智能判断如何处理用户问题

**核心功能**:
- 意图识别 (产品介绍 / 具体问题 / 闲聊)
- 判断是否需要查询飞书文档
- 路由到相应的处理模块

**决策逻辑**:
```
用户消息 -> 意图分析 -> {
  产品介绍: 直接使用产品知识库
  技术问题: 查询飞书技术文档
  商务问题: 查询飞书商务文档
  闲聊: 直接AI回复
}
```

### 3. AI对话引擎 (AI Dialog Engine)

**职责**: 生成自然语言回复

**核心功能**:
- 调用LLM API
- 管理对话上下文
- 注入产品知识和检索结果
- 生成友好回复

**Prompt工程**:
```
系统提示词:
- 你是XX公司的产品顾问
- 你需要友好、专业地介绍产品
- 如果不确定，引导客户咨询人工

上下文: {对话历史}
知识: {产品信息 + 检索到的文档}
问题: {用户问题}
```

### 4. 知识库检索模块 (Knowledge Retriever)

**职责**: 从飞书查询相关文档

**核心功能**:
- 调用飞书搜索API
- 解析文档内容
- 语义相似度排序 (可选)
- 内容摘要提取

**实现方案**:
- **基础版**: 直接使用飞书搜索API
- **增强版**: 预先索引+向量检索

### 5. 产品知识管理 (Product Knowledge)

**职责**: 存储和管理产品信息

**存储内容**:
- 产品基本介绍
- 核心功能列表
- 常见FAQ
- 价格方案
- 联系方式

**数据格式**:
```json
{
  "product_name": "XX产品",
  "description": "产品描述",
  "features": ["特性1", "特性2"],
  "faqs": [
    {"q": "问题", "a": "答案"}
  ]
}
```

## 实现路线

### Phase 1: MVP最小可行版本 (1-2周)
- [ ] 飞书消息收发
- [ ] 基础AI对话 (固定产品介绍)
- [ ] 简单问答 (基于FAQ)

### Phase 2: 知识库集成 (1周)
- [ ] 接入飞书搜索API
- [ ] 实现文档检索
- [ ] 结果整合到回复中

### Phase 3: 智能优化 (1-2周)
- [ ] 意图识别优化
- [ ] 对话上下文管理
- [ ] 回复质量提升

### Phase 4: 生产就绪 (1周)
- [ ] 错误处理和日志
- [ ] 性能优化
- [ ] 监控和运维

## 部署架构

```
[用户] -> [飞书] -> [公网] -> [Nginx] -> [FastAPI服务]
                                             |
                                             +-> [SQLite/PostgreSQL]
                                             +-> [Redis Cache]
                                             +-> [LLM API]
                                             +-> [飞书API]
```

## 关键技术决策

### 1. 为什么选择FastAPI?
- 高性能异步框架
- 自动API文档
- 类型提示支持

### 2. 为什么需要对话路由器?
- 避免每次都查询文档 (节省成本)
- 提高响应速度
- 精准调用知识库

### 3. 是否需要向量数据库?
- **1.0版本不需要**: 直接用飞书搜索API
- **后续版本**: 如果文档量大，可以引入

### 4. LLM选择建议
- **Claude**: 更适合中文，上下文理解好
- **GPT-4**: 生态成熟，插件丰富
- **国产模型**: 合规性考虑

## 成本估算

### API调用成本
- LLM API: 约¥0.01-0.1/次对话
- 飞书API: 免费 (在配额内)

### 服务器成本
- 1核2G服务器: ¥50-100/月
- 适合日活100-500用户

## 风险与挑战

1. **飞书API限流**: 需要实现请求缓存和频控
2. **LLM幻觉**: 需要加强prompt工程和事实核查
3. **响应延迟**: 异步处理 + 流式输出优化
4. **成本控制**: 对话长度限制 + 缓存策略

## 下一步行动

1. 搭建开发环境
2. 注册飞书开放平台应用
3. 实现MVP版本
4. 小范围测试
5. 迭代优化
