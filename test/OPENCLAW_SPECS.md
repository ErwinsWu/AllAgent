# 🦞 OpenClaw Feishu Bot: 基于 Skills 架构的功能需求与测试清单

## 1. 项目概述
本项目基于 [AllAgent](https://github.com/ErwinsWu/AllAgent) 的演进思路，旨在弃用单一 Agent 模式，转而采用 **OpenClaw + Skills** 的多技能编排架构。

系统将包含一个核心的 **OpenClaw 控制器**，以及多个专精的 **Skills（技能）**，其中包含一个专门用于回答常规提问的通用 AI。

## 2. 核心架构与功能需求

### 2.1 架构组件
*   **OpenClaw Core**: 负责意图识别、上下文管理、以及 Skill 的分发（Routing）。
*   **Skill A: 动态知识库技能 (RAG)**: 处理企业静态文档及用户实时上传的文件（PDF/图片）。
*   **Skill B: 常规提问 AI (General AI)**: 处理基于预设 FAQ 文档（doc）的高频问答，以及兜底的闲聊。
*   **Skill C: 视觉与文档解析技能**: 专门处理 OCR、去水印解析、PDF 结构化提取。

### 2.2 功能列表
1.  **知识库问答**:
    *   支持预设的企业级知识库。
    *   **动态扩展**: 支持客户或内部人员在对话框中发送文件（PDF/图片），即时加入该会话的分析范围。
2.  **常规提问与闲聊**:
    *   集成一个专门的 AI 模型，优先依据整理好的 `FAQ.doc` 回答高频同类型问题。
3.  **多模态读取**:
    *   **PDF**: 能够理解长文档内容。
    *   **图片**: 能够提取图片中的文字与数据，**需具备抗水印干扰能力**。
4.  **上下文与多维记忆**:
    *   **单客户对话**: 记忆私聊的历史上下文。
    *   **多群聊隔离**: 同一个 Agent 在不同群聊中应拥有独立的记忆空间，互不串线。

---

## 3. 技术难点与应对策略 (Technical Challenges & Solutions)

在使用 OpenClaw 落地过程中，以下技术点是实施的关键：

### 3.1 难点：图片水印干扰与 OCR 精度
**问题描述**：企业内部或客户发送的图片/截图通常带有“机密”、“仅供内部使用”或个人 ID 的水印。传统 OCR 容易将水印文字混入正文，导致语义混乱（例如：将“机密”二字插入到句子中间）。
*   **应对策略**:
    *   **Vision Model Prompting**: 如果使用 GPT-4o/Claude-3.5 等多模态大模型，需在 System Prompt 中明确指令：*“提取图片内容时，请忽略背景中的半透明水印或版权标记，仅关注核心文本内容。”*
    *   **预处理 Skill**: 在传入 LLM 前，通过 OpenCV 算法检测并淡化水印（如果水印样式固定），或使用专门的去噪模型。

### 3.2 难点：文件权限的动态隔离
**问题描述**：OpenClaw 需要区分“谁”发的文件。不能让 Skill A 将用户甲上传的工资单作为知识，回答给用户乙。
*   **应对策略**:
    *   **Session-Scoped Vector Store**: 知识库 Skill 在存储向量时，必须附带 `session_id` 或 `user_id` 作为元数据（Metadata）。
    *   **检索过滤**: 查询时，强制添加 Filter 条件：`metadata.scope == 'global' OR metadata.session_id == current_session`。

### 3.3 难点：常规 AI 与 知识库 Skill 的路由冲突
**问题描述**：用户问“怎么报销？”。这既可能在 `FAQ.doc` (常规 AI) 里，也可能在用户刚传的 `员工手册.pdf` (知识库 Skill) 里。
*   **应对策略**:
    *   **优先级机制 (Priority Chain)**: OpenClaw 应设定执行顺序：
        1.  先调用 **常规 AI (Skill B)** 检查 FAQ 匹配度。
        2.  如果 FAQ 匹配度 > 0.9，直接返回。
        3.  否则，调用 **知识库技能 (Skill A)** 进行深度检索。

---

## 4. 详细测试清单与案例 (Test Cases & Scenarios)

测试不仅要验证“能不能用”，还要验证“会不会出错”。以下是具体的测试场景：

### 4.1 文件权限与隔离测试 (重点)

| 测试项 | 场景描述 (Scenario) | 预期结果 (Expectation) | 失败对策 |
| :--- | :--- | :--- | :--- |
| **T-01: 跨群隔离** | 1. 在群 A 上传文件 `Project_X.pdf`。<br>2. 在群 B 询问“Project X 的进度”。 | 群 B 的 Agent 回复“没有相关信息”或“未找到文件”。 | 检查 OpenClaw 传递给 Skill 的 Session ID 是否正确区分了 Chat ID。 |
| **T-02: 私有文件保护** | 1. 用户 A 私聊发送文件。<br>2. 用户 B 私聊询问该文件内容。 | Agent 对用户 B 保密。 | 检查向量数据库的 Filter 逻辑，确保没有查询全局范围。 |

### 4.2 图片与水印处理测试

| 测试项 | 场景描述 (Scenario) | 预期结果 (Expectation) | 失败对策 |
| :--- | :--- | :--- | :--- |
| **T-03: 强水印干扰** | 发送一张正文被“CONFIDENTIAL”斜体水印覆盖的合同截图。 | Agent 能准确复述合同条款，且回答中**不包含**无意义的“CONFIDENTIAL”单词插入。 | 优化 Vision Skill 的 Prompt，强调“Ignore Watermarks”；或更换抗干扰更强的 Vision 模型。 |
| **T-04: 模糊/小图测试** | 发送一张手机拍摄的、光线较暗的文档照片。 | 能识别出主要文字意思，若无法识别应提示“图片不清晰”。 | 增加图片增强预处理步骤。 |

### 4.3 常规 AI (FAQ) 优先级测试

| 测试项 | 场景描述 (Scenario) | 预期结果 (Expectation) | 失败对策 |
| :--- | :--- | :--- | :--- |
| **T-05: 知识冲突优先** | FAQ 文档规定“A=1”，用户上传文件说“A=2”。提问“A是多少？” | Agent 优先回答“A=1”（依据公司标准 FAQ）。 | 调整 OpenClaw 的路由权重，确保 FAQ Skill 的置信度阈值高于 RAG Skill。 |
| **T-06: 闲聊兜底** | 提问“你叫什么名字”或“讲个笑话”。 | 由常规 AI 技能流畅回答，而不是去知识库里强行搜索关键词。 | 检查常规 AI 的 Prompt 设定，确保具备基本的 Persona（人设）。 |

### 4.4 上下文与并发测试

| 测试项 | 场景描述 (Scenario) | 预期结果 (Expectation) | 失败对策 |
| :--- | :--- | :--- | :--- |
| **T-07: 多群并发** | 同时在 3 个群组 @机器人 提问。 | 3 个群组均能在 3-5 秒内收到回复，无串线，无报错。 | 检查飞书回调的异步处理队列（Celery/Redis），避免 HTTP 阻塞。 |
| **T-08: 话题切换记忆** | 1. 传文件 A。<br>2. 聊家常。<br>3. 回头问文件 A 的细节。 | Agent 依然能回答文件 A 的内容。 | 检查 OpenClaw 的 Memory 模块，确认滑动窗口（Sliding Window）大小足够覆盖多轮对话。 |

---

## 5. 部署注意事项
*   **飞书鉴权**: 读取图片/文件流需要处理 `message_resource` 的鉴权 Token，注意 Token 的有效期。
*   **OpenClaw Config**: 需配置好各 Skill 的 Tool Description，以便 LLM 准确进行路由选择。
